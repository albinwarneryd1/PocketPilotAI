<EditForm Model="model" OnValidSubmit="HandleSubmit" class="form-grid single">
  <DataAnnotationsValidator />

  <div class="form-grid">
    <PremiumFormField Label="Account ID">
      <InputText @bind-Value="model.AccountId" placeholder="Account GUID" />
    </PremiumFormField>

    <PremiumFormField Label="Merchant">
      <InputText @bind-Value="model.MerchantName" placeholder="Merchant name" />
    </PremiumFormField>

    <PremiumFormField Label="Amount (SEK)">
      <InputNumber @bind-Value="model.Amount" />
    </PremiumFormField>

    <PremiumFormField Label="Date">
      <InputDate @bind-Value="model.DateUtc" />
    </PremiumFormField>

    <PremiumFormField Label="Type">
      <InputSelect @bind-Value="model.Type">
        <option value="@PocketPilotAI.Core.Domain.Enums.TransactionType.Expense">Expense</option>
        <option value="@PocketPilotAI.Core.Domain.Enums.TransactionType.Income">Income</option>
        <option value="@PocketPilotAI.Core.Domain.Enums.TransactionType.Transfer">Transfer</option>
      </InputSelect>
    </PremiumFormField>

    <PremiumFormField Label="Currency">
      <InputText @bind-Value="model.Currency" />
    </PremiumFormField>

    <PremiumFormField Label="Notes">
      <InputText @bind-Value="model.Notes" placeholder="Optional note" />
    </PremiumFormField>

    <PremiumFormField Label="Recurring">
      <InputCheckbox @bind-Value="model.IsRecurring" />
    </PremiumFormField>
  </div>

  <div class="action-row form-sticky-submit">
    <button class="btn-primary" type="submit">Save transaction</button>
  </div>

  @if (!string.IsNullOrWhiteSpace(Error))
  {
    <p class="error-text">@Error</p>
  }
</EditForm>

@code {
  [Parameter] public EventCallback<CreateTransactionRequest> OnSubmit { get; set; }

  private TransactionFormModel model = new();

  private string? Error { get; set; }

  private async Task HandleSubmit()
  {
    if (!Guid.TryParse(model.AccountId, out Guid accountId))
    {
      Error = "Account ID must be a valid GUID.";
      return;
    }

    Error = null;

    await OnSubmit.InvokeAsync(new CreateTransactionRequest
    {
      AccountId = accountId,
      MerchantName = model.MerchantName,
      Amount = model.Amount,
      Currency = model.Currency,
      DateUtc = DateTime.SpecifyKind(model.DateUtc, DateTimeKind.Utc),
      Notes = model.Notes,
      Type = model.Type,
      IsRecurring = model.IsRecurring
    });
  }

  private sealed class TransactionFormModel
  {
    public string AccountId { get; set; } = string.Empty;

    public string MerchantName { get; set; } = string.Empty;

    public decimal Amount { get; set; }

    public string Currency { get; set; } = "SEK";

    public DateTime DateUtc { get; set; } = DateTime.UtcNow.Date;

    public PocketPilotAI.Core.Domain.Enums.TransactionType Type { get; set; } = PocketPilotAI.Core.Domain.Enums.TransactionType.Expense;

    public string Notes { get; set; } = string.Empty;

    public bool IsRecurring { get; set; }
  }
}
