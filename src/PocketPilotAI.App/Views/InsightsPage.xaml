<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Name="InsightsPageRoot"
             x:Class="PocketPilotAI.App.Views.InsightsPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:ai="clr-namespace:PocketPilotAI.Core.Application.Dtos.Ai;assembly=PocketPilotAI.Core"
             xmlns:components="clr-namespace:PocketPilotAI.App.Components"
             xmlns:viewmodels="clr-namespace:PocketPilotAI.App.ViewModels"
             x:DataType="viewmodels:InsightsViewModel"
             Title="Insights">

  <ScrollView>
    <VerticalStackLayout x:Name="InsightsRoot" Padding="24" Spacing="24">
      <VerticalStackLayout Spacing="8">
        <Label Text="AI Coach" Style="{StaticResource MetaLabel}" />
        <Label Text="Guided Simulation" Style="{StaticResource PageTitleLabel}" />
        <Label Text="Test behavior changes in real time before committing." Style="{StaticResource BodyLabel}" TextColor="{StaticResource FinMuted}" />
      </VerticalStackLayout>

      <components:MetricHeroView Eyebrow="Scenario impact"
                                 Title="What-if impact score"
                                 Subtitle="Higher score means stronger projected monthly improvement."
                                 Score="{Binding ImpactScore}"
                                 ScoreCaption="{Binding ImpactSummary}" />

      <components:AIExplanationBlockView Title="Monthly narrative"
                                         Body="{Binding MonthlyNarrative}" />

      <Border Style="{StaticResource SurfaceBorderStyle}">
        <VerticalStackLayout Spacing="16">
          <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
            <Label Grid.Column="0" Text="Live what-if simulator" Style="{StaticResource SectionTitleLabel}" />
            <components:TrendBadgeView Grid.Column="1" Text="{Binding LastUpdatedLabel}" Variant="neutral" />
          </Grid>

          <CollectionView ItemsSource="{Binding Templates}" ItemsLayout="HorizontalList" HeightRequest="140">
            <CollectionView.ItemTemplate>
              <DataTemplate x:DataType="ai:WhatIfScenarioTemplateDto">
                <Border Style="{StaticResource SurfaceBorderStyle}" Padding="16" WidthRequest="260" Margin="0,0,12,0">
                  <VerticalStackLayout Spacing="8">
                    <Label Text="{Binding Name}" Style="{StaticResource SectionTitleLabel}" />
                    <Label Text="{Binding Description}" Style="{StaticResource MetaLabel}" />
                    <Button Text="Use preset"
                            Style="{StaticResource PrimaryButtonStyle}"
                            Command="{Binding Source={x:Reference InsightsPageRoot}, Path=BindingContext.ApplyTemplateCommand}"
                            CommandParameter="{Binding .}" />
                  </VerticalStackLayout>
                </Border>
              </DataTemplate>
            </CollectionView.ItemTemplate>
          </CollectionView>

          <Grid ColumnDefinitions="*,*" ColumnSpacing="12" RowDefinitions="Auto,Auto,Auto" RowSpacing="12">
            <Border Grid.Row="0" Grid.Column="0" Style="{StaticResource InputSurfaceStyle}">
              <Entry Placeholder="Scenario name" Text="{Binding ScenarioName}" />
            </Border>

            <Border Grid.Row="0" Grid.Column="1" Style="{StaticResource InputSurfaceStyle}">
              <Picker Title="Action type"
                      ItemsSource="{Binding ActionTypes}"
                      SelectedItem="{Binding SelectedActionType}" />
            </Border>

            <Border Grid.Row="1" Grid.Column="0" Style="{StaticResource InputSurfaceStyle}">
              <Entry Placeholder="Category" Text="{Binding CategoryName}" />
            </Border>

            <Border Grid.Row="1" Grid.Column="1" Style="{StaticResource InputSurfaceStyle}">
              <Entry Placeholder="Value" Keyboard="Numeric" Text="{Binding Value}" />
            </Border>

            <Border Grid.Row="2" Grid.Column="0" Style="{StaticResource InputSurfaceStyle}">
              <Entry Placeholder="Year" Keyboard="Numeric" Text="{Binding Year}" />
            </Border>

            <Border Grid.Row="2" Grid.Column="1" Style="{StaticResource InputSurfaceStyle}">
              <Entry Placeholder="Month" Keyboard="Numeric" Text="{Binding Month}" />
            </Border>
          </Grid>

          <Button Text="Run simulation" Style="{StaticResource PrimaryButtonStyle}" Command="{Binding RunWhatIfCommand}" />
          <Label Text="{Binding SimulationSummary}" Style="{StaticResource MetaLabel}" />
        </VerticalStackLayout>
      </Border>

      <Border Style="{StaticResource SurfaceBorderStyle}" IsVisible="{Binding HasSimulationResult}">
        <VerticalStackLayout Spacing="12">
          <Label Text="KPI comparison" Style="{StaticResource SectionTitleLabel}" />

          <CollectionView ItemsSource="{Binding KpiComparisons}" SelectionMode="None">
            <CollectionView.ItemTemplate>
              <DataTemplate x:DataType="viewmodels:KpiComparisonItem">
                <Border Style="{StaticResource SurfaceBorderStyle}" Padding="14" Margin="0,0,0,10">
                  <VerticalStackLayout Spacing="8">
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                      <Label Grid.Column="0" Text="{Binding Label}" Style="{StaticResource BodyLabel}" FontFamily="OpenSansSemibold" />
                      <Label Grid.Column="1" Text="{Binding SimulatedText}" Style="{StaticResource MetaLabel}" />
                    </Grid>

                    <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto" ColumnSpacing="8" RowSpacing="5">
                      <Label Grid.Row="0" Grid.Column="0" Text="Baseline" Style="{StaticResource MetaLabel}" />
                      <ProgressBar Grid.Row="0" Grid.Column="1" Progress="{Binding BaselineRatio}" ProgressColor="#95A7B9" HeightRequest="8" />
                      <Label Grid.Row="1" Grid.Column="0" Text="Simulated" Style="{StaticResource MetaLabel}" />
                      <ProgressBar Grid.Row="1" Grid.Column="1" Progress="{Binding SimulatedRatio}" ProgressColor="{StaticResource FinAccent}" HeightRequest="8" />
                    </Grid>

                    <Label Text="{Binding BaselineText, StringFormat='Baseline: {0}'}" Style="{StaticResource MetaLabel}" />
                  </VerticalStackLayout>
                </Border>
              </DataTemplate>
            </CollectionView.ItemTemplate>
          </CollectionView>
        </VerticalStackLayout>
      </Border>

      <components:RecommendationCardView Title="Top recommendation"
                                         Description="{Binding TopRecommendation}"
                                         CtaText="Track this in transactions"
                                         CtaCommand="{Binding RefreshCommand}" />

      <Border Style="{StaticResource SurfaceBorderStyle}">
        <VerticalStackLayout Spacing="16">
          <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
            <Label Grid.Column="0" Text="Leak insights" Style="{StaticResource SectionTitleLabel}" />
            <Button Grid.Column="1" Text="Refresh" Style="{StaticResource PrimaryButtonStyle}" Command="{Binding RefreshCommand}" />
          </Grid>

          <HorizontalStackLayout Spacing="8" BindableLayout.ItemsSource="{Binding LeakBadges}">
            <BindableLayout.ItemTemplate>
              <DataTemplate x:DataType="viewmodels:TrendBadgeItem">
                <components:TrendBadgeView Text="{Binding Text}" Variant="{Binding Variant}" />
              </DataTemplate>
            </BindableLayout.ItemTemplate>
          </HorizontalStackLayout>

          <CollectionView ItemsSource="{Binding Cards}" ItemsLayout="HorizontalList" HeightRequest="280">
            <CollectionView.ItemTemplate>
              <DataTemplate x:DataType="ai:InsightCardDto">
                <components:InsightCardView WidthRequest="320"
                                            Title="{Binding Title}"
                                            Description="{Binding Description}"
                                            ActionText="{Binding SuggestedAction}"
                                            SavingsText="{Binding EstimatedMonthlySavings, StringFormat='{}{0:0} SEK/month potential'}" />
              </DataTemplate>
            </CollectionView.ItemTemplate>
          </CollectionView>
        </VerticalStackLayout>
      </Border>
    </VerticalStackLayout>
  </ScrollView>
</ContentPage>
