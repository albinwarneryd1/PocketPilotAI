@page "/insights"
@inject InsightsApi InsightsApi
@implements IDisposable

<div class="page-stack">
  <section class="page-head">
    <div class="page-head-copy">
      <p class="page-kicker">AI coach</p>
      <h2 class="page-title">Insights & what-if simulation</h2>
      <p class="muted">Model decisions before you change behavior in real life.</p>
    </div>

    <a class="btn-primary" href="#whatif">Run scenario</a>
  </section>

  @if (heroInsight is not null)
  {
    <HeroCard AdditionalClass="card-rise">
      <div class="section-header">
        <div class="section-header-copy">
          <p class="metric-eyebrow">Top insight</p>
          <h3>@heroInsight.Title</h3>
          <p class="primary-copy">@heroInsight.Description</p>
        </div>

        <TrendBadge Label="@($"{heroInsight.Confidence * 100m:0}% confidence")" Variant="neutral" />
      </div>

      <div class="action-row">
        <span class="save-pill">~@heroInsight.EstimatedMonthlySavings.ToString("0") SEK/month potential</span>
        <a class="btn-secondary" href="/transactions">Review transactions</a>
      </div>

      <RecommendationCard
        Title="Action plan"
        Description="@heroInsight.SuggestedAction"
        ImpactText="@($"Estimated monthly impact: {heroInsight.EstimatedMonthlySavings:0} SEK")"
        CtaLabel="Open transaction feed"
        CtaHref="/transactions" />
    </HeroCard>

    <AIExplanationBlock
      Title="Why this recommendation is prioritized"
      Body="@topNarrative"
      IsLoading="@isLoadingNarrative" />
  }

  <section class="panel" id="whatif">
    <div class="section-header">
      <div class="section-header-copy">
        <h3 class="section-title">Live what-if simulator</h3>
        <p class="muted">Change one variable and see the KPI delta instantly.</p>
      </div>

      <TrendBadge Label="Live updates" Variant="up" />
    </div>

    @if (templates.Any())
    {
      <div class="preset-row">
        @foreach (var template in templates)
        {
          <button type="button" class="preset-chip @(template.Name == selectedTemplateName ? "selected" : string.Empty)" @onclick="() => OnTemplateSelected(template)">
            <span>@template.Name</span>
            <small>@template.SuggestedCategory • @template.SuggestedValue.ToString("0.#")</small>
          </button>
        }
      </div>
    }

    <div class="form-grid">
      <PremiumFormField Label="Scenario name">
        <InputText @bind-Value="ScenarioNameInput" />
      </PremiumFormField>

      <PremiumFormField Label="Year">
        <InputNumber @bind-Value="YearInput" />
      </PremiumFormField>

      <PremiumFormField Label="Month">
        <InputNumber @bind-Value="MonthInput" />
      </PremiumFormField>

      <PremiumFormField Label="Action type">
        <InputSelect @bind-Value="SelectedTypeInput">
          @foreach (var type in actionTypes)
          {
            <option value="@type">@ToDisplay(type)</option>
          }
        </InputSelect>
      </PremiumFormField>

      <PremiumFormField Label="Category">
        <InputText @bind-Value="CategoryInput" />
      </PremiumFormField>

      <PremiumFormField Label="Value">
        <InputNumber @bind-Value="ActionValueInput" />
      </PremiumFormField>
    </div>

    <div class="action-row">
      <button class="btn-primary" @onclick="RunSimulation" disabled="@isSimulating">@(isSimulating ? "Simulating..." : "Run simulation")</button>
      <TrendBadge Label="@lastUpdatedLabel" Variant="neutral" />
    </div>

    @if (simulation is null)
    {
      <InlineCard AdditionalClass="card-rise">
        <div class="skeleton-stack">
          <span class="skeleton-line full"></span>
          <span class="skeleton-line medium"></span>
          <span class="skeleton-line short"></span>
        </div>
      </InlineCard>
    }
    else
    {
      <MetricHero
        Eyebrow="Scenario impact"
        Title="What-if impact score"
        Subtitle="Higher score means stronger improvement in net cash flow and savings rate."
        MicroExplanation="@impactSummary"
        Score="impactScore"
        ValueLabel="@($"Net delta {simulation.Delta.NetDelta:0} SEK")"
        PrimaryActionLabel="Apply this as monthly target"
        PrimaryActionHref="/transactions"
        SparklinePoints="simulationSparkline" />

      <div class="whatif-grid">
        <BaseCard AdditionalClass="card-rise">
          <p class="metric-eyebrow">Baseline</p>
          <p>Income: <strong>@simulation.Baseline.Income.ToString("0") SEK</strong></p>
          <p>Expenses: <strong>@simulation.Baseline.Expenses.ToString("0") SEK</strong></p>
          <p>Net: <strong>@simulation.Baseline.Net.ToString("0") SEK</strong></p>
        </BaseCard>

        <BaseCard AdditionalClass="card-rise">
          <p class="metric-eyebrow">Simulated</p>
          <p>Income: <strong>@simulation.Simulated.Income.ToString("0") SEK</strong></p>
          <p>Expenses: <strong>@simulation.Simulated.Expenses.ToString("0") SEK</strong></p>
          <p>Net: <strong>@simulation.Simulated.Net.ToString("0") SEK</strong></p>
        </BaseCard>

        <BaseCard AdditionalClass="card-rise">
          <p class="metric-eyebrow">Delta</p>
          <p>Income: <strong>@simulation.Delta.IncomeDelta.ToString("0") SEK</strong></p>
          <p>Expenses: <strong>@simulation.Delta.ExpenseDelta.ToString("0") SEK</strong></p>
          <p>Net: <strong>@simulation.Delta.NetDelta.ToString("0") SEK</strong></p>
        </BaseCard>
      </div>

      <ListCard AdditionalClass="card-rise">
        <h4>KPI comparison</h4>
        @foreach (var row in GetComparisonRows(simulation))
        {
          decimal max = Math.Max(Math.Abs(row.Baseline), Math.Abs(row.Simulated));
          <div class="compare-row">
            <div class="compare-label">
              <span>@row.Label</span>
              <strong>@FormatMetric(row.Simulated, row.IsPercent)</strong>
            </div>

            <div class="compare-bars">
              <div class="compare-bar baseline">
                <div style="width:@BarWidth(row.Baseline, max)"></div>
              </div>
              <div class="compare-bar simulated">
                <div style="width:@BarWidth(row.Simulated, max)"></div>
              </div>
            </div>

            <small class="muted">Baseline @FormatMetric(row.Baseline, row.IsPercent) → Simulated @FormatMetric(row.Simulated, row.IsPercent)</small>
          </div>
        }
      </ListCard>

      <RecommendationCard
        Title="Next best move"
        Description="@(simulation.Recommendations.FirstOrDefault() ?? simulation.Explanation)"
        ImpactText="@($"Expected improvement: {simulation.Delta.NetDelta:0} SEK/month")"
        CtaLabel="Apply this strategy"
        CtaHref="/transactions" />

      <AIExplanationBlock Title="Why this scenario works" Body="@simulation.Explanation" />
    }
  </section>

  <section class="panel">
    <div class="section-header">
      <div class="section-header-copy">
        <h3 class="section-title">Additional opportunities</h3>
        <p class="muted">Compact recommendations to complement your main plan.</p>
      </div>

      <div class="badge-row">
        @foreach (var badge in leakBadges)
        {
          <TrendBadge Label="@badge.Label" Variant="@badge.Variant" />
        }
      </div>
    </div>

    @if (!compactInsights.Any())
    {
      <p class="muted">No additional insights available.</p>
    }
    else
    {
      <div class="insight-grid">
        @foreach (var card in compactInsights)
        {
          <InsightCard Item="card" ActionLabel="Open" ActionHref="/transactions" />
        }
      </div>
    }
  </section>
</div>

@code {
  private readonly WhatIfActionType[] actionTypes = Enum.GetValues<WhatIfActionType>();

  private IReadOnlyList<InsightCardDto> allInsights = [];
  private IReadOnlyList<InsightCardDto> compactInsights = [];
  private IReadOnlyList<WhatIfScenarioTemplateDto> templates = [];
  private IReadOnlyList<BadgeItem> leakBadges = [];

  private InsightCardDto? heroInsight;
  private WhatIfSimulationResultDto? simulation;

  private string topNarrative = string.Empty;
  private bool isLoadingNarrative = true;

  private string scenarioName = "30-day plan";
  private int year = DateTime.UtcNow.Year;
  private int month = DateTime.UtcNow.Month;
  private WhatIfActionType selectedType = WhatIfActionType.ReduceCategoryPercent;
  private string categoryName = "Eating Out";
  private decimal actionValue = 15;
  private string selectedTemplateName = string.Empty;

  private int impactScore;
  private string impactSummary = "No simulation yet.";
  private string lastUpdatedLabel = "Not simulated";
  private IReadOnlyList<decimal> simulationSparkline = [20m, 22m, 26m, 24m, 31m, 36m];

  private bool isSimulating;
  private CancellationTokenSource? debounceCts;

  private string ScenarioNameInput
  {
    get => scenarioName;
    set
    {
      if (scenarioName == value)
      {
        return;
      }

      scenarioName = value;
      _ = QueueSimulationAsync();
    }
  }

  private int YearInput
  {
    get => year;
    set
    {
      if (year == value)
      {
        return;
      }

      year = value;
      _ = QueueSimulationAsync();
    }
  }

  private int MonthInput
  {
    get => month;
    set
    {
      if (month == value)
      {
        return;
      }

      month = value;
      _ = QueueSimulationAsync();
    }
  }

  private WhatIfActionType SelectedTypeInput
  {
    get => selectedType;
    set
    {
      if (selectedType == value)
      {
        return;
      }

      selectedType = value;
      _ = QueueSimulationAsync();
    }
  }

  private string CategoryInput
  {
    get => categoryName;
    set
    {
      if (categoryName == value)
      {
        return;
      }

      categoryName = value;
      _ = QueueSimulationAsync();
    }
  }

  private decimal ActionValueInput
  {
    get => actionValue;
    set
    {
      if (actionValue == value)
      {
        return;
      }

      actionValue = value;
      _ = QueueSimulationAsync();
    }
  }

  protected override async Task OnInitializedAsync()
  {
    templates = await InsightsApi.GetWhatIfTemplatesAsync();
    if (templates.Any())
    {
      ApplyTemplate(templates[0]);
    }

    allInsights = await InsightsApi.GetLeakInsightsAsync(new LeakFinderRequest
    {
      FromUtc = DateTime.UtcNow.AddMonths(-1),
      ToUtc = DateTime.UtcNow,
      MaxSuggestions = 5
    });

    heroInsight = allInsights.FirstOrDefault();
    compactInsights = allInsights.Skip(1).Take(4).ToList();
    leakBadges = BuildLeakBadges(allInsights);

    IReadOnlyList<InsightCardDto> monthlySummary = await InsightsApi.GetMonthlySummaryAsync(new MonthlySummaryRequest
    {
      Year = DateTime.UtcNow.Year,
      Month = DateTime.UtcNow.Month
    });

    topNarrative = monthlySummary.FirstOrDefault()?.Description
      ?? heroInsight?.Description
      ?? "AI narrative is not available for this cycle yet.";

    isLoadingNarrative = false;

    await RunSimulation();
  }

  private async Task RunSimulation()
  {
    isSimulating = true;

    try
    {
      simulation = await InsightsApi.SimulateAsync(new WhatIfSimulationRequest
      {
        ScenarioName = scenarioName,
        Year = year,
        Month = month,
        Actions =
        [
          new WhatIfActionDto
          {
            Type = selectedType,
            Label = selectedType.ToString(),
            CategoryName = categoryName,
            Value = actionValue,
            TransactionType = selectedType == WhatIfActionType.AddRecurringIncome
              ? PocketPilotAI.Core.Domain.Enums.TransactionType.Income
              : PocketPilotAI.Core.Domain.Enums.TransactionType.Expense,
            IsRecurring = selectedType != WhatIfActionType.AddOneOffTransaction,
            EffectiveDateUtc = DateTime.UtcNow
          }
        ]
      });

      if (simulation is null)
      {
        impactScore = 0;
        impactSummary = "Simulation failed.";
        lastUpdatedLabel = "Simulation failed";
        return;
      }

      impactScore = BuildImpactScore(simulation.Delta.NetDelta, simulation.Delta.SavingsRateDeltaPercent);
      impactSummary = $"Net delta {simulation.Delta.NetDelta:0} SEK • Savings delta {simulation.Delta.SavingsRateDeltaPercent:0.0}%";
      lastUpdatedLabel = $"Updated {DateTime.Now:HH:mm:ss}";

      simulationSparkline =
      [
        simulation.Baseline.Net,
        simulation.Simulated.Net,
        simulation.Baseline.SavingsRatePercent,
        simulation.Simulated.SavingsRatePercent,
        simulation.Delta.NetDelta,
        simulation.Delta.SavingsRateDeltaPercent
      ];
    }
    finally
    {
      isSimulating = false;
    }
  }

  private void OnTemplateSelected(WhatIfScenarioTemplateDto template)
  {
    ApplyTemplate(template);
    _ = QueueSimulationAsync();
  }

  private async Task QueueSimulationAsync()
  {
    debounceCts?.Cancel();
    debounceCts?.Dispose();
    debounceCts = new CancellationTokenSource();

    try
    {
      await Task.Delay(320, debounceCts.Token);
      await RunSimulation();
      await InvokeAsync(StateHasChanged);
    }
    catch (TaskCanceledException)
    {
      // Ignore rapid input changes.
    }
  }

  private void ApplyTemplate(WhatIfScenarioTemplateDto template)
  {
    selectedTemplateName = template.Name;
    selectedType = template.ActionType;
    categoryName = template.SuggestedCategory;
    actionValue = template.SuggestedValue;
    scenarioName = $"{template.Name} scenario";
  }

  private static string ToDisplay(WhatIfActionType type)
    => type switch
    {
      WhatIfActionType.ReduceCategoryPercent => "Reduce category by %",
      WhatIfActionType.ReduceCategoryFixed => "Reduce category by fixed amount",
      WhatIfActionType.AddRecurringIncome => "Add recurring income",
      WhatIfActionType.AddRecurringExpense => "Add recurring expense",
      WhatIfActionType.AddOneOffTransaction => "Add one-off transaction",
      WhatIfActionType.RemoveDetectedSubscriptions => "Remove detected subscriptions",
      _ => type.ToString()
    };

  private static int BuildImpactScore(decimal netDelta, decimal savingsRateDelta)
  {
    decimal score = 50m;
    score += Math.Clamp(netDelta / 100m, -25m, 35m);
    score += Math.Clamp(savingsRateDelta * 2m, -20m, 25m);

    return (int)Math.Clamp(Math.Round(score), 0, 100);
  }

  private static string BarWidth(decimal value, decimal max)
  {
    decimal width = max <= 0 ? 0 : (Math.Abs(value) / max) * 100m;
    return $"{width:0}%";
  }

  private static string FormatMetric(decimal value, bool isPercent)
    => isPercent ? $"{value:0.0}%" : $"{value:0} SEK";

  private static IReadOnlyList<ComparisonRow> GetComparisonRows(WhatIfSimulationResultDto result)
    =>
    [
      new("Income", result.Baseline.Income, result.Simulated.Income),
      new("Expenses", result.Baseline.Expenses, result.Simulated.Expenses),
      new("Net", result.Baseline.Net, result.Simulated.Net),
      new("Savings rate", result.Baseline.SavingsRatePercent, result.Simulated.SavingsRatePercent, true)
    ];

  private static IReadOnlyList<BadgeItem> BuildLeakBadges(IReadOnlyList<InsightCardDto> leakCards)
  {
    if (leakCards.Count == 0)
    {
      return [new BadgeItem("No leaks detected", "up")];
    }

    decimal totalSavingsPotential = leakCards.Sum(x => x.EstimatedMonthlySavings);
    decimal avgConfidence = leakCards.Average(x => x.Confidence);

    return
    [
      new BadgeItem($"{leakCards.Count} insights", "neutral"),
      new BadgeItem($"{totalSavingsPotential:0} SEK potential", "up"),
      new BadgeItem($"{avgConfidence * 100m:0}% confidence", avgConfidence >= 0.7m ? "up" : "neutral")
    ];
  }

  public void Dispose()
  {
    debounceCts?.Cancel();
    debounceCts?.Dispose();
  }

  private sealed record ComparisonRow(string Label, decimal Baseline, decimal Simulated, bool IsPercent = false);

  private sealed record BadgeItem(string Label, string Variant);
}
