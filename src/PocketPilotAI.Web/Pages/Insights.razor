@page "/insights"
@inject InsightsApi InsightsApi
@implements IDisposable

<div class="page-stack decision-flow">
  <section class="page-head">
    <div class="page-head-copy">
      <p class="page-kicker">Insights</p>
      <h2 class="page-title">What-if result</h2>
      <p class="muted">Understand impact in seconds, then act.</p>
    </div>
  </section>

  <SceneHero
    Label="Impact outcome"
    TargetNumber="heroDeltaNumber"
    NumberSuffix=" SEK / month"
    IncludePlusForPositive="true"
    Subtitle="@heroOutcomeSubtitle"
    ActionHint="@($"If you apply this scenario")"
    PrimaryActionLabel="Apply scenario"
    PrimaryActionHref="/transactions"
    SecondaryActionLabel="Adjust scenario"
    SecondaryActionHref="#scenario-details"
    GaugeValue="impactScore"
    SparklinePoints="simulationSparkline" />

  <InlineCard AdditionalClass="scene-inline card-rise">
    <h3>Why this matters</h3>

    @if (isLoadingNarrative)
    {
      <div class="skeleton-stack" aria-hidden="true">
        <span class="skeleton-line full"></span>
        <span class="skeleton-line medium"></span>
      </div>
      <p class="muted">Generating your monthly insights...</p>
    }
    else
    {
      <p class="scene-inline-main">@humanExplanation</p>
    }

    <p class="scene-inline-action"><strong>Next move:</strong> @topRecommendation</p>
    <a class="btn-primary" href="/transactions">Apply this plan</a>
  </InlineCard>

  <section class="panel">
    <div class="section-header-copy">
      <h3 class="section-title">Before vs after</h3>
      <p class="muted">One visualization focused on your decision impact.</p>
    </div>

    @if (simulation is null)
    {
      <div class="skeleton-stack" aria-hidden="true">
        <span class="skeleton-line full"></span>
        <span class="skeleton-line medium"></span>
      </div>
    }
    else
    {
      <div class="before-after-chart card-rise">
        @foreach (var row in outcomeRows)
        {
          decimal max = Math.Max(Math.Abs(row.Before), Math.Abs(row.After));
          <div class="before-after-item">
            <div class="before-after-head">
              <span class="before-after-label">@row.Label</span>
              <strong>@FormatMetric(row.After, row.IsPercent)</strong>
            </div>

            <div class="compare-bar baseline">
              <div style="width:@BarWidth(row.Before, max)"></div>
            </div>
            <div class="compare-bar simulated">
              <div style="width:@BarWidth(row.After, max)"></div>
            </div>

            <small class="muted">Before @FormatMetric(row.Before, row.IsPercent) -> After @FormatMetric(row.After, row.IsPercent)</small>
          </div>
        }
      </div>
    }
  </section>

  <details class="decision-details" id="scenario-details">
    <summary>Show scenario controls and detailed metrics</summary>
    <div class="decision-details-body">
      <section class="panel">
        <div class="section-header-copy">
          <h3 class="section-title">Scenario controls</h3>
          <p class="muted">Adjust one variable and rerun.</p>
        </div>

        @if (templates.Any())
        {
          <div class="preset-row">
            @foreach (var template in templates)
            {
              <button type="button" class="preset-chip @(template.Name == selectedTemplateName ? "selected" : string.Empty)" @onclick="() => OnTemplateSelected(template)">
                <span>@template.Name</span>
                <small>@template.SuggestedCategory â€¢ @template.SuggestedValue.ToString("0.#")</small>
              </button>
            }
          </div>
        }

        <div class="form-grid">
          <PremiumFormField Label="Scenario name">
            <InputText @bind-Value="ScenarioNameInput" />
          </PremiumFormField>

          <PremiumFormField Label="Year">
            <InputNumber @bind-Value="YearInput" />
          </PremiumFormField>

          <PremiumFormField Label="Month">
            <InputNumber @bind-Value="MonthInput" />
          </PremiumFormField>

          <PremiumFormField Label="Action type">
            <InputSelect @bind-Value="SelectedTypeInput">
              @foreach (var type in actionTypes)
              {
                <option value="@type">@ToDisplay(type)</option>
              }
            </InputSelect>
          </PremiumFormField>

          <PremiumFormField Label="Category">
            <InputText @bind-Value="CategoryInput" />
          </PremiumFormField>

          <PremiumFormField Label="Value">
            <InputNumber @bind-Value="ActionValueInput" />
          </PremiumFormField>
        </div>

        <div class="action-row">
          <button class="btn-primary" @onclick="RunSimulation" disabled="@isSimulating">@(isSimulating ? "Updating..." : "Run simulation")</button>
          <TrendBadge Label="@lastUpdatedLabel" Variant="neutral" />
        </div>
      </section>

      @if (simulation is not null)
      {
        <section class="panel">
          <div class="kpi-grid">
            <BaseCard>
              <p class="scene-label">Before</p>
              <p>Income <strong>@simulation.Baseline.Income.ToString("0") SEK</strong></p>
              <p>Expenses <strong>@simulation.Baseline.Expenses.ToString("0") SEK</strong></p>
              <p>Net <strong>@simulation.Baseline.Net.ToString("0") SEK</strong></p>
            </BaseCard>
            <BaseCard>
              <p class="scene-label">After</p>
              <p>Income <strong>@simulation.Simulated.Income.ToString("0") SEK</strong></p>
              <p>Expenses <strong>@simulation.Simulated.Expenses.ToString("0") SEK</strong></p>
              <p>Net <strong>@simulation.Simulated.Net.ToString("0") SEK</strong></p>
            </BaseCard>
            <BaseCard>
              <p class="scene-label">Delta</p>
              <p>Income <strong>@simulation.Delta.IncomeDelta.ToString("0") SEK</strong></p>
              <p>Expenses <strong>@simulation.Delta.ExpenseDelta.ToString("0") SEK</strong></p>
              <p>Net <strong>@simulation.Delta.NetDelta.ToString("0") SEK</strong></p>
            </BaseCard>
          </div>
        </section>
      }

      @if (supportingInsights.Any())
      {
        <section class="panel">
          <div class="section-header-copy">
            <h3 class="section-title">Supporting insights</h3>
          </div>
          <div class="insight-grid">
            @foreach (var card in supportingInsights)
            {
              <InsightCard Item="card" ActionLabel="Review" ActionHref="/transactions" />
            }
          </div>
        </section>
      }
    </div>
  </details>
</div>

@code {
  private readonly WhatIfActionType[] actionTypes = Enum.GetValues<WhatIfActionType>();

  private IReadOnlyList<InsightCardDto> allInsights = [];
  private IReadOnlyList<InsightCardDto> supportingInsights = [];
  private IReadOnlyList<WhatIfScenarioTemplateDto> templates = [];

  private WhatIfSimulationResultDto? simulation;
  private InsightCardDto? primaryInsight;

  private string scenarioName = "30-day plan";
  private int year = DateTime.UtcNow.Year;
  private int month = DateTime.UtcNow.Month;
  private WhatIfActionType selectedType = WhatIfActionType.ReduceCategoryPercent;
  private string categoryName = "Eating Out";
  private decimal actionValue = 15;
  private string selectedTemplateName = string.Empty;

  private bool isSimulating;
  private bool isLoadingNarrative = true;
  private string lastUpdatedLabel = "Not simulated";

  private decimal heroDeltaNumber;
  private string heroOutcomeSubtitle = "Run your scenario to see potential impact.";
  private string humanExplanation = "Generating your monthly insights...";
  private string topRecommendation = "Run one simulation and apply the best outcome.";
  private int impactScore;

  private IReadOnlyList<decimal> simulationSparkline = [20m, 24m, 26m, 30m, 34m, 38m];
  private IReadOnlyList<OutcomeRow> outcomeRows = [];

  private CancellationTokenSource? debounceCts;

  private string ScenarioNameInput
  {
    get => scenarioName;
    set
    {
      if (scenarioName == value)
      {
        return;
      }

      scenarioName = value;
      _ = QueueSimulationAsync();
    }
  }

  private int YearInput
  {
    get => year;
    set
    {
      if (year == value)
      {
        return;
      }

      year = value;
      _ = QueueSimulationAsync();
    }
  }

  private int MonthInput
  {
    get => month;
    set
    {
      if (month == value)
      {
        return;
      }

      month = value;
      _ = QueueSimulationAsync();
    }
  }

  private WhatIfActionType SelectedTypeInput
  {
    get => selectedType;
    set
    {
      if (selectedType == value)
      {
        return;
      }

      selectedType = value;
      _ = QueueSimulationAsync();
    }
  }

  private string CategoryInput
  {
    get => categoryName;
    set
    {
      if (categoryName == value)
      {
        return;
      }

      categoryName = value;
      _ = QueueSimulationAsync();
    }
  }

  private decimal ActionValueInput
  {
    get => actionValue;
    set
    {
      if (actionValue == value)
      {
        return;
      }

      actionValue = value;
      _ = QueueSimulationAsync();
    }
  }

  protected override async Task OnInitializedAsync()
  {
    templates = await InsightsApi.GetWhatIfTemplatesAsync();
    if (templates.Any())
    {
      ApplyTemplate(templates[0]);
    }

    allInsights = await InsightsApi.GetLeakInsightsAsync(new LeakFinderRequest
    {
      FromUtc = DateTime.UtcNow.AddMonths(-1),
      ToUtc = DateTime.UtcNow,
      MaxSuggestions = 5
    });

    primaryInsight = allInsights.FirstOrDefault();
    supportingInsights = allInsights.Skip(1).Take(2).ToList();

    await BuildNarrativeAsync();
    await RunSimulation();
  }

  private async Task BuildNarrativeAsync()
  {
    isLoadingNarrative = true;

    IReadOnlyList<InsightCardDto> monthlySummary = await InsightsApi.GetMonthlySummaryAsync(new MonthlySummaryRequest
    {
      Year = DateTime.UtcNow.Year,
      Month = DateTime.UtcNow.Month
    });

    string narrative = monthlySummary.FirstOrDefault()?.Description
      ?? primaryInsight?.Description
      ?? "No narrative available yet.";

    humanExplanation = RewriteToHumanTone(narrative);
    topRecommendation = primaryInsight?.SuggestedAction
      ?? monthlySummary.FirstOrDefault()?.SuggestedAction
      ?? "Apply one realistic cut in your highest growth category.";

    isLoadingNarrative = false;
  }

  private async Task RunSimulation()
  {
    isSimulating = true;

    try
    {
      simulation = await InsightsApi.SimulateAsync(new WhatIfSimulationRequest
      {
        ScenarioName = scenarioName,
        Year = year,
        Month = month,
        Actions =
        [
          new WhatIfActionDto
          {
            Type = selectedType,
            Label = selectedType.ToString(),
            CategoryName = categoryName,
            Value = actionValue,
            TransactionType = selectedType == WhatIfActionType.AddRecurringIncome
              ? PocketPilotAI.Core.Domain.Enums.TransactionType.Income
              : PocketPilotAI.Core.Domain.Enums.TransactionType.Expense,
            IsRecurring = selectedType != WhatIfActionType.AddOneOffTransaction,
            EffectiveDateUtc = DateTime.UtcNow
          }
        ]
      });

      if (simulation is null)
      {
        heroDeltaNumber = 0;
        heroOutcomeSubtitle = "Try adjusting your scenario and run again.";
        outcomeRows = [];
        impactScore = 0;
        lastUpdatedLabel = "Simulation failed";
        return;
      }

      BuildHeroStory(simulation);
      BuildOutcomeRows(simulation);
      lastUpdatedLabel = $"Updated {DateTime.Now:HH:mm:ss}";
    }
    finally
    {
      isSimulating = false;
    }
  }

  private void BuildHeroStory(WhatIfSimulationResultDto result)
  {
    heroDeltaNumber = result.Delta.NetDelta;

    heroOutcomeSubtitle = result.Delta.NetDelta >= 0
      ? $"You could save about {result.Delta.NetDelta:0} SEK/month if you apply this scenario."
      : $"This scenario would reduce your monthly net by {Math.Abs(result.Delta.NetDelta):0} SEK.";

    impactScore = BuildImpactScore(result.Delta.NetDelta, result.Delta.SavingsRateDeltaPercent);

    simulationSparkline =
    [
      result.Baseline.Net,
      result.Simulated.Net,
      result.Baseline.SavingsRatePercent,
      result.Simulated.SavingsRatePercent,
      result.Delta.NetDelta,
      result.Delta.SavingsRateDeltaPercent
    ];

    if (result.Recommendations.Any())
    {
      topRecommendation = result.Recommendations[0];
    }

    humanExplanation = result.Delta.NetDelta >= 0
      ? $"You could save ~{result.Delta.NetDelta:0} SEK/month by reducing {categoryName} by {actionValue:0.#}."
      : $"This scenario increases pressure by ~{Math.Abs(result.Delta.NetDelta):0} SEK/month. Try a smaller cut in {categoryName}.";
  }

  private void BuildOutcomeRows(WhatIfSimulationResultDto result)
  {
    outcomeRows =
    [
      new("Net", result.Baseline.Net, result.Simulated.Net),
      new("Savings rate", result.Baseline.SavingsRatePercent, result.Simulated.SavingsRatePercent, true)
    ];
  }

  private void OnTemplateSelected(WhatIfScenarioTemplateDto template)
  {
    ApplyTemplate(template);
    _ = QueueSimulationAsync();
  }

  private async Task QueueSimulationAsync()
  {
    debounceCts?.Cancel();
    debounceCts?.Dispose();
    debounceCts = new CancellationTokenSource();

    try
    {
      await Task.Delay(320, debounceCts.Token);
      await RunSimulation();
      await InvokeAsync(StateHasChanged);
    }
    catch (TaskCanceledException)
    {
      // ignore rapid input churn
    }
  }

  private void ApplyTemplate(WhatIfScenarioTemplateDto template)
  {
    selectedTemplateName = template.Name;
    selectedType = template.ActionType;
    categoryName = template.SuggestedCategory;
    actionValue = template.SuggestedValue;
    scenarioName = $"{template.Name} scenario";
  }

  private static string RewriteToHumanTone(string input)
  {
    if (string.IsNullOrWhiteSpace(input))
    {
      return "You can improve your month by making one small adjustment in your highest-growth category.";
    }

    return input
      .Replace("Scenario shifts", "You can change")
      .Replace("net cash flow", "your monthly net")
      .Replace("If current behavior continues", "If you keep this pace")
      .Trim();
  }

  private static string ToDisplay(WhatIfActionType type)
    => type switch
    {
      WhatIfActionType.ReduceCategoryPercent => "Reduce category by %",
      WhatIfActionType.ReduceCategoryFixed => "Reduce category by fixed amount",
      WhatIfActionType.AddRecurringIncome => "Add recurring income",
      WhatIfActionType.AddRecurringExpense => "Add recurring expense",
      WhatIfActionType.AddOneOffTransaction => "Add one-off transaction",
      WhatIfActionType.RemoveDetectedSubscriptions => "Remove subscriptions",
      _ => type.ToString()
    };

  private static int BuildImpactScore(decimal netDelta, decimal savingsRateDelta)
  {
    decimal score = 50m;
    score += Math.Clamp(netDelta / 100m, -25m, 35m);
    score += Math.Clamp(savingsRateDelta * 2m, -20m, 25m);

    return (int)Math.Clamp(Math.Round(score), 0, 100);
  }

  private static string BarWidth(decimal value, decimal max)
  {
    decimal width = max <= 0 ? 0 : (Math.Abs(value) / max) * 100m;
    return $"{width:0}%";
  }

  private static string FormatMetric(decimal value, bool isPercent)
    => isPercent ? $"{value:0.0}%" : $"{value:0} SEK";

  public void Dispose()
  {
    debounceCts?.Cancel();
    debounceCts?.Dispose();
  }

  private sealed record OutcomeRow(string Label, decimal Before, decimal After, bool IsPercent = false);
}
