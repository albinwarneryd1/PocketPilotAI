@page "/insights"
@inject InsightsApi InsightsApi

<h2>AI Coach</h2>
<p class="muted">Concrete, data-driven suggestions from your recent spending.</p>

<div class="action-row">
  <button class="btn-primary" @onclick="LoadInsights">Generate Leak Insights</button>
</div>

@if (!cards.Any())
{
  <p class="muted">No insights loaded yet.</p>
}
else
{
  <div class="insight-grid">
    @foreach (var card in cards)
    {
      <article class="insight-card">
        <h3>@card.Title</h3>
        <p>@card.Description</p>
        <p><strong>Action:</strong> @card.SuggestedAction</p>
        <p><strong>Estimated savings:</strong> @card.EstimatedMonthlySavings.ToString("0") SEK/month</p>
      </article>
    }
  </div>
}

<section class="panel">
  <h3>What-if simulation</h3>
  <p class="muted">Model monthly impact before changing your habits.</p>

  @if (templates.Any())
  {
    <div class="preset-row">
      @foreach (var template in templates)
      {
        <button type="button" class="@TemplateClass(template)" @onclick="@(() => ApplyTemplate(template))">
          <span>@template.Name</span>
          <small>@template.SuggestedCategory - @template.SuggestedValue.ToString("0.#")</small>
        </button>
      }
    </div>
  }

  <div class="form-grid">
    <label>
      Scenario name
      <InputText @bind-Value="scenarioName" />
    </label>

    <label>
      Year
      <InputNumber @bind-Value="year" />
    </label>

    <label>
      Month
      <InputNumber @bind-Value="month" />
    </label>

    <label>
      Action type
      <InputSelect @bind-Value="selectedType">
        @foreach (var template in templates)
        {
          <option value="@template.ActionType">@template.Name</option>
        }
      </InputSelect>
    </label>

    <label>
      Category
      <InputText @bind-Value="categoryName" />
    </label>

    <label>
      Value
      <InputNumber @bind-Value="actionValue" />
    </label>
  </div>

  <button class="btn-primary" @onclick="RunSimulation">Run simulation</button>

  @if (simulation is not null)
  {
    <div class="whatif-grid">
      <article class="insight-card">
        <h4>Baseline</h4>
        <p>Income: @simulation.Baseline.Income.ToString("0") SEK</p>
        <p>Expenses: @simulation.Baseline.Expenses.ToString("0") SEK</p>
        <p>Net: @simulation.Baseline.Net.ToString("0") SEK</p>
      </article>

      <article class="insight-card">
        <h4>Simulated</h4>
        <p>Income: @simulation.Simulated.Income.ToString("0") SEK</p>
        <p>Expenses: @simulation.Simulated.Expenses.ToString("0") SEK</p>
        <p>Net: @simulation.Simulated.Net.ToString("0") SEK</p>
      </article>

      <article class="insight-card">
        <h4>Delta</h4>
        <p>Income delta: @simulation.Delta.IncomeDelta.ToString("0") SEK</p>
        <p>Expense delta: @simulation.Delta.ExpenseDelta.ToString("0") SEK</p>
        <p>Net delta: @simulation.Delta.NetDelta.ToString("0") SEK</p>
      </article>
    </div>

    <article class="insight-card" style="margin-top: 0.8rem;">
      <h4>KPI comparison</h4>
      @foreach (var row in GetComparisonRows(simulation))
      {
        decimal max = Math.Max(Math.Abs(row.Baseline), Math.Abs(row.Simulated));
        <div class="compare-row">
          <div class="compare-label">
            <span>@row.Label</span>
            <strong>@FormatMetric(row.Simulated, row.IsPercent)</strong>
          </div>

          <div class="compare-bars">
            <div class="compare-bar baseline">
              <div style="width:@BarWidth(row.Baseline, max)"></div>
            </div>
            <div class="compare-bar simulated">
              <div style="width:@BarWidth(row.Simulated, max)"></div>
            </div>
          </div>

          <small class="muted">Baseline @FormatMetric(row.Baseline, row.IsPercent) -> Simulated @FormatMetric(row.Simulated, row.IsPercent)</small>
        </div>
      }
    </article>

    <article class="insight-card" style="margin-top: 0.8rem;">
      <h4>Recommendations</h4>
      <ul>
        @foreach (var recommendation in simulation.Recommendations)
        {
          <li>@recommendation</li>
        }
      </ul>
      <p><strong>Explanation:</strong> @simulation.Explanation</p>
    </article>
  }
</section>

@code {
  private IReadOnlyList<InsightCardDto> cards = [];
  private IReadOnlyList<WhatIfScenarioTemplateDto> templates = [];
  private WhatIfSimulationResultDto? simulation;

  private string scenarioName = "Test Scenario";
  private int year = DateTime.UtcNow.Year;
  private int month = DateTime.UtcNow.Month;
  private WhatIfActionType selectedType = WhatIfActionType.ReduceCategoryPercent;
  private string categoryName = "Eating Out";
  private decimal actionValue = 15;
  private string selectedTemplateName = string.Empty;

  protected override async Task OnInitializedAsync()
  {
    templates = await InsightsApi.GetWhatIfTemplatesAsync();
    if (templates.Any())
    {
      ApplyTemplate(templates[0]);
    }
  }

  private async Task LoadInsights()
  {
    cards = await InsightsApi.GetLeakInsightsAsync(new LeakFinderRequest
    {
      FromUtc = DateTime.UtcNow.AddMonths(-1),
      ToUtc = DateTime.UtcNow,
      MaxSuggestions = 3
    });
  }

  private async Task RunSimulation()
  {
    simulation = await InsightsApi.SimulateAsync(new WhatIfSimulationRequest
    {
      ScenarioName = scenarioName,
      Year = year,
      Month = month,
      Actions =
      [
        new WhatIfActionDto
        {
          Type = selectedType,
          Label = selectedType.ToString(),
          CategoryName = categoryName,
          Value = actionValue,
          TransactionType = selectedType == WhatIfActionType.AddRecurringIncome ? PocketPilotAI.Core.Domain.Enums.TransactionType.Income : PocketPilotAI.Core.Domain.Enums.TransactionType.Expense,
          IsRecurring = selectedType != WhatIfActionType.AddOneOffTransaction,
          EffectiveDateUtc = DateTime.UtcNow
        }
      ]
    });
  }

  private void ApplyTemplate(WhatIfScenarioTemplateDto template)
  {
    selectedTemplateName = template.Name;
    selectedType = template.ActionType;
    categoryName = template.SuggestedCategory;
    actionValue = template.SuggestedValue;
    scenarioName = $"{template.Name} scenario";
  }

  private string TemplateClass(WhatIfScenarioTemplateDto template)
    => template.Name == selectedTemplateName ? "preset-chip selected" : "preset-chip";

  private static string BarWidth(decimal value, decimal max)
  {
    decimal width = max <= 0 ? 0 : (Math.Abs(value) / max) * 100m;
    return $"{width:0}%";
  }

  private static string FormatMetric(decimal value, bool isPercent)
    => isPercent
      ? $"{value:0.0}%"
      : $"{value:0} SEK";

  private static IReadOnlyList<ComparisonRow> GetComparisonRows(WhatIfSimulationResultDto result)
    =>
    [
      new("Income", result.Baseline.Income, result.Simulated.Income),
      new("Expenses", result.Baseline.Expenses, result.Simulated.Expenses),
      new("Net", result.Baseline.Net, result.Simulated.Net),
      new("Savings rate", result.Baseline.SavingsRatePercent, result.Simulated.SavingsRatePercent, true)
    ];

  private sealed record ComparisonRow(string Label, decimal Baseline, decimal Simulated, bool IsPercent = false);
}
