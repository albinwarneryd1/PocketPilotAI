@page "/register"
@inject AuthApi AuthApi
@inject UserSessionState Session
@inject NavigationManager NavigationManager

<div class="auth-page">
  <HeroCard AdditionalClass="auth-card card-rise">
    <div class="auth-brand">
      <span class="auth-brand-mark">PP</span>
      <div>
        <p class="page-kicker">PocketPilotAI</p>
        <h2 class="page-title">Create your account</h2>
      </div>
    </div>

    <p class="muted">Start syncing transactions and unlock AI coaching across web and app.</p>

    <div class="form-grid single">
      <PremiumFormField Label="Display name">
        <InputText @bind-Value="displayName" placeholder="Your name" />
      </PremiumFormField>

      <PremiumFormField Label="Email">
        <InputText @bind-Value="email" placeholder="you@example.com" />
      </PremiumFormField>

      <PremiumFormField Label="Password">
        <InputText @bind-Value="password" type="password" placeholder="Create password" />
      </PremiumFormField>
    </div>

    <div class="auth-actions">
      <button class="btn-primary" @onclick="SubmitRegister" disabled="@isBusy">@(isBusy ? "Creating..." : "Create account")</button>
      <a class="btn-tertiary" href="/login">Already have an account?</a>
    </div>

    @if (!string.IsNullOrWhiteSpace(error))
    {
      <p class="error-text">@error</p>
    }
  </HeroCard>
</div>

@code {
  [SupplyParameterFromQuery] public string? ReturnUrl { get; set; }

  private string displayName = string.Empty;
  private string email = string.Empty;
  private string password = string.Empty;
  private string? error;
  private bool isBusy;

  protected override void OnInitialized()
  {
    if (Session.IsAuthenticated)
    {
      NavigationManager.NavigateTo("/overview");
    }
  }

  private async Task SubmitRegister()
  {
    isBusy = true;
    error = null;

    try
    {
      var token = await AuthApi.RegisterAsync(new PocketPilotAI.Core.Application.Dtos.Users.RegisterUserRequest
      {
        DisplayName = displayName,
        Email = email,
        Password = password
      });

      if (token is null)
      {
        error = "Could not create account. Try another email.";
        return;
      }

      Session.SetSession(token);
      string target = string.IsNullOrWhiteSpace(ReturnUrl)
        ? "/overview"
        : (ReturnUrl.StartsWith("/") ? ReturnUrl : $"/{ReturnUrl}");

      NavigationManager.NavigateTo(target);
    }
    catch (Exception)
    {
      error = "Registration failed. Check API and try again.";
    }
    finally
    {
      isBusy = false;
    }
  }
}
