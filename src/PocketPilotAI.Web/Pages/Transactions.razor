@page "/transactions"

<div class="page-stack decision-flow">
  <section class="page-head">
    <div class="page-head-copy">
      <p class="page-kicker">Transactions</p>
      <h2 class="page-title">Spending decisions</h2>
      <p class="muted">One metric, one recommendation, one review list.</p>
    </div>

    <a class="btn-primary" href="/add-transaction">Add transaction</a>
  </section>

  <SceneHero
    Label="Spending pattern health"
    TargetNumber="@pulseScore"
    NumberSuffix=" / 100"
    Subtitle="@pulseSummary"
    ActionHint="@($"Average transaction: {averageAmount:0} SEK")"
    PrimaryActionLabel="Improve with what-if"
    PrimaryActionHref="/insights"
    GaugeValue="pulseScore"
    SparklinePoints="spendingSparkline" />

  <InlineCard AdditionalClass="scene-inline card-rise">
    <h3>AI pattern insight</h3>
    <p class="scene-inline-main">@patternNarrative</p>
    <a class="btn-secondary" href="/insights">Open simulation</a>
  </InlineCard>

  <section class="panel">
    <div class="section-header">
      <div class="section-header-copy">
        <h3 class="section-title">Transaction list</h3>
        <p class="muted">Main review area. Filter then act.</p>
      </div>
    </div>

    <div class="form-grid">
      <PremiumFormField Label="Month">
        <InputSelect @bind-Value="selectedMonth" @onchange="OnFilterChanged">
          @foreach (var month in monthFilters)
          {
            <option value="@month.Key">@month.Label</option>
          }
        </InputSelect>
      </PremiumFormField>

      <PremiumFormField Label="Category">
        <InputSelect @bind-Value="selectedCategory" @onchange="OnFilterChanged">
          @foreach (var category in categoryFilters)
          {
            <option value="@category">@category</option>
          }
        </InputSelect>
      </PremiumFormField>
    </div>

    @if (!filteredItems.Any())
    {
      <InlineCard AdditionalClass="card-rise">
        <p class="muted">No transactions match your filters.</p>
      </InlineCard>
    }
    else
    {
      <div class="transactions-list">
        @foreach (var item in filteredItems)
        {
          <ListCard AdditionalClass="card-rise">
            <div class="transaction-row">
              <div>
                <h4>@(string.IsNullOrWhiteSpace(item.MerchantName) ? "Unknown merchant" : item.MerchantName)</h4>
                <p class="muted">@(string.IsNullOrWhiteSpace(item.CategoryName) ? "Uncategorized" : item.CategoryName)</p>
                <div class="transaction-meta">
                  <TrendBadge Label="@item.DateUtc.ToString("yyyy-MM-dd")" Variant="neutral" />
                  @if (item.IsRecurring)
                  {
                    <TrendBadge Label="Recurring" Variant="up" />
                  }
                </div>
              </div>

              <div class="transaction-amount">
                <strong>@item.Amount.ToString("0.##") @item.Currency</strong>
                <span class="muted">@item.Type</span>
              </div>
            </div>
          </ListCard>
        }
      </div>
    }
  </section>

  <details class="decision-details">
    <summary>Show advanced quality details</summary>
    <div class="decision-details-body">
      <section class="panel">
        <div class="kpi-grid">
          <BaseCard>
            <p class="scene-label">In view</p>
            <strong>@filteredItems.Count</strong>
          </BaseCard>
          <BaseCard>
            <p class="scene-label">Recurring</p>
            <strong>@recurringCount</strong>
          </BaseCard>
          <BaseCard>
            <p class="scene-label">Uncategorized</p>
            <strong>@uncategorizedCount</strong>
          </BaseCard>
        </div>
      </section>
    </div>
  </details>
</div>

<a class="btn-primary sticky-cta" href="/add-transaction">Add transaction</a>

@code {
  [Inject] private TransactionsApi TransactionsApi { get; set; } = default!;

  private IReadOnlyList<TransactionDto> items = [];
  private IReadOnlyList<TransactionDto> filteredItems = [];

  private IReadOnlyList<MonthFilterItem> monthFilters = [];
  private IReadOnlyList<string> categoryFilters = [];
  private IReadOnlyList<decimal> spendingSparkline = [8m, 9m, 10m, 9m, 11m, 12m];

  private string selectedMonth = "all";
  private string selectedCategory = "all";

  private int pulseScore;
  private int recurringCount;
  private int uncategorizedCount;
  private decimal averageAmount;
  private string pulseSummary = "No transaction data yet.";
  private string patternNarrative = "Loading transaction insight...";

  protected override async Task OnInitializedAsync()
  {
    items = (await TransactionsApi.GetAsync())
      .OrderByDescending(x => x.DateUtc)
      .ToList();

    monthFilters = BuildMonthFilters(items);
    categoryFilters = BuildCategoryFilters(items);

    ApplyFiltersAndInsights();
  }

  private Task OnFilterChanged(ChangeEventArgs _)
  {
    ApplyFiltersAndInsights();
    return Task.CompletedTask;
  }

  private void ApplyFiltersAndInsights()
  {
    IEnumerable<TransactionDto> query = items;

    if (selectedMonth != "all")
    {
      var (year, month) = ParseMonthFilter(selectedMonth);
      query = query.Where(x => x.DateUtc.Year == year && x.DateUtc.Month == month);
    }

    if (selectedCategory != "all")
    {
      query = query.Where(x => string.Equals(x.CategoryName ?? "Uncategorized", selectedCategory, StringComparison.OrdinalIgnoreCase));
    }

    filteredItems = query.ToList();

    decimal total = filteredItems.Sum(x => x.Amount);
    recurringCount = filteredItems.Count(x => x.IsRecurring);
    uncategorizedCount = filteredItems.Count(x => string.IsNullOrWhiteSpace(x.CategoryName));
    averageAmount = filteredItems.Any() ? total / filteredItems.Count : 0;

    pulseScore = BuildPulseScore(uncategorizedCount, recurringCount, filteredItems.Count);

    pulseSummary = filteredItems.Any()
      ? $"{filteredItems.Count} records in view. Recurring: {recurringCount}. Uncategorized: {uncategorizedCount}."
      : "No transactions in this filter set.";

    string topCategory = filteredItems
      .Where(x => !string.IsNullOrWhiteSpace(x.CategoryName))
      .GroupBy(x => x.CategoryName)
      .OrderByDescending(g => g.Sum(x => x.Amount))
      .Select(g => g.Key)
      .FirstOrDefault() ?? "Uncategorized";

    patternNarrative = filteredItems.Any()
      ? $"Your biggest spend category here is {topCategory}. Cleaning uncategorized transactions first improves recommendation quality."
      : "Add transactions to unlock pattern detection and recommendations.";

    spendingSparkline = BuildSparkline(items);
  }

  private static IReadOnlyList<decimal> BuildSparkline(IReadOnlyList<TransactionDto> source)
  {
    if (!source.Any())
    {
      return [8m, 9m, 10m, 9m, 11m, 12m];
    }

    DateTime anchor = new DateTime(source.Max(x => x.DateUtc).Year, source.Max(x => x.DateUtc).Month, 1);
    List<decimal> values = [];

    for (int i = 5; i >= 0; i--)
    {
      DateTime month = anchor.AddMonths(-i);
      decimal spend = source
        .Where(x => x.Type == PocketPilotAI.Core.Domain.Enums.TransactionType.Expense)
        .Where(x => x.DateUtc.Year == month.Year && x.DateUtc.Month == month.Month)
        .Sum(x => x.Amount);

      values.Add(spend <= 0 ? 1m : spend);
    }

    return values;
  }

  private static IReadOnlyList<MonthFilterItem> BuildMonthFilters(IReadOnlyList<TransactionDto> source)
  {
    List<MonthFilterItem> filters = [new("all", "All")];

    filters.AddRange(source
      .Select(x => new DateTime(x.DateUtc.Year, x.DateUtc.Month, 1))
      .Distinct()
      .OrderByDescending(x => x)
      .Take(6)
      .Select(x => new MonthFilterItem($"{x.Year:D4}-{x.Month:D2}", x.ToString("MMM yyyy"))));

    return filters;
  }

  private static IReadOnlyList<string> BuildCategoryFilters(IReadOnlyList<TransactionDto> source)
    => ["all", .. source
      .Select(x => string.IsNullOrWhiteSpace(x.CategoryName) ? "Uncategorized" : x.CategoryName)
      .Distinct(StringComparer.OrdinalIgnoreCase)
      .OrderBy(x => x)
      .Take(10)];

  private static (int year, int month) ParseMonthFilter(string key)
  {
    string[] parts = key.Split('-', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
    return parts.Length == 2 && int.TryParse(parts[0], out int year) && int.TryParse(parts[1], out int month)
      ? (year, month)
      : (DateTime.UtcNow.Year, DateTime.UtcNow.Month);
  }

  private static int BuildPulseScore(int uncategorized, int recurring, int total)
  {
    if (total == 0)
    {
      return 0;
    }

    decimal quality = 74m;
    quality -= (uncategorized / (decimal)total) * 42m;
    quality += recurring > 0 ? 8m : -4m;

    return (int)Math.Clamp(Math.Round(quality), 0, 100);
  }

  private sealed record MonthFilterItem(string Key, string Label);
}
