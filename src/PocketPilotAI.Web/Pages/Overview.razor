@page "/"
@page "/overview"
@inject UserSessionState Session

<div class="page-stack decision-flow">
  <section class="page-head">
    <div class="page-head-copy">
      <p class="page-kicker">Overview</p>
      <h2 class="page-title">Your monthly status</h2>
      <p class="muted">One outcome, one recommendation, one next step.</p>
    </div>

    <select class="month-selector" value="@selectedMonthKey" @onchange="OnMonthChanged" aria-label="Month selector">
      @foreach (var option in monthOptions)
      {
        <option value="@option.Key">@option.Label</option>
      }
    </select>
  </section>

  <HeroCard AdditionalClass="decision-hero card-rise">
    <p class="decision-kicker">Current status</p>
    <h3 class="decision-value">@healthScore / 100</h3>
    <p class="decision-subtitle">@healthSummary</p>

    <div class="action-row">
      <a class="btn-primary" href="/insights">Open what-if</a>
      <a class="btn-secondary" href="#overview-details">See details</a>
    </div>

    @if (actionChips.Any())
    {
      <div class="outcome-chip-row">
        @foreach (var chip in actionChips)
        {
          <span class="outcome-chip">@chip</span>
        }
      </div>
    }
  </HeroCard>

  <AIExplanationBlock
    Title="Monthly narrative"
    Body="@monthlyNarrative"
    IsLoading="@isLoadingNarrative" />

  <RecommendationCard
    Title="Next best move"
    Description="@primaryRecommendation"
    ImpactText="@($"This could save about {estimatedImpact:0} SEK/month")"
    CtaLabel="Start a plan"
    CtaHref="/insights" />

  <section class="panel">
    <div class="section-header-copy">
      <h3 class="section-title">Spending trend</h3>
      <p class="muted">Single chart to show your pace over time.</p>
    </div>

    @if (!trendItems.Any())
    {
      <p class="muted">Not enough historical data for trend analysis.</p>
    }
    else
    {
      <div class="bars">
        @foreach (var item in trendItems)
        {
          decimal width = trendMax <= 0 ? 0 : (item.Amount / trendMax) * 100m;
          <div class="bar-row card-rise">
            <span>@item.Label</span>
            <div class="bar-track"><div class="bar-fill" style="width:@($"{width:0}%")"></div></div>
            <strong>@item.Amount.ToString("0") SEK</strong>
          </div>
        }
      </div>
    }
  </section>

  <details class="decision-details" id="overview-details">
    <summary>Supporting details</summary>
    <div class="decision-details-body">
      <section class="panel">
        <div class="section-header-copy">
          <h3 class="section-title">Leak opportunities</h3>
          <p class="muted">Detailed insights you can apply this month.</p>
        </div>

        @if (!leakCards.Any())
        {
          <p class="muted">No leak opportunities found for this month yet.</p>
        }
        else
        {
          <div class="insight-grid">
            @foreach (var card in leakCards.Take(4))
            {
              <InsightCard Item="card" ActionLabel="Review" ActionHref="/transactions" />
            }
          </div>
        }
      </section>

      <section class="panel">
        <div class="kpi-grid">
          <BaseCard>
            <p class="metric-eyebrow">Income</p>
            <strong>@income.ToString("0") SEK</strong>
          </BaseCard>
          <BaseCard>
            <p class="metric-eyebrow">Expenses</p>
            <strong>@expenses.ToString("0") SEK</strong>
          </BaseCard>
          <BaseCard>
            <p class="metric-eyebrow">Remaining budget</p>
            <strong>@remainingBudget.ToString("0") SEK</strong>
          </BaseCard>
        </div>
      </section>
    </div>
  </details>
</div>

@code {
  [Inject] private TransactionsApi TransactionsApi { get; set; } = default!;
  [Inject] private BudgetsApi BudgetsApi { get; set; } = default!;
  [Inject] private InsightsApi InsightsApi { get; set; } = default!;

  private IReadOnlyList<TransactionDto> allTransactions = [];
  private IReadOnlyList<InsightCardDto> leakCards = [];
  private IReadOnlyList<TrendItem> trendItems = [];
  private IReadOnlyList<MonthOption> monthOptions = [];

  private string selectedMonthKey = string.Empty;
  private string monthlyNarrative = string.Empty;
  private bool isLoadingNarrative = true;

  private decimal income;
  private decimal expenses;
  private decimal remainingBudget;
  private decimal recurringShare;
  private decimal trendMax;
  private decimal estimatedImpact;

  private int healthScore;
  private string healthSummary = "Score pending";
  private string primaryRecommendation = "Open what-if and apply one scenario this month.";
  private IReadOnlyList<string> actionChips = [];

  protected override async Task OnInitializedAsync()
  {
    allTransactions = await TransactionsApi.GetAsync();

    monthOptions = BuildMonthOptions(allTransactions);
    selectedMonthKey = monthOptions.FirstOrDefault()?.Key ?? BuildKey(DateTime.UtcNow.Year, DateTime.UtcNow.Month);

    await RefreshOverviewAsync();
  }

  private async Task OnMonthChanged(ChangeEventArgs args)
  {
    string? key = args.Value?.ToString();
    if (string.IsNullOrWhiteSpace(key) || key == selectedMonthKey)
    {
      return;
    }

    selectedMonthKey = key;
    await RefreshOverviewAsync();
  }

  private async Task RefreshOverviewAsync()
  {
    (int year, int month) = ParseKey(selectedMonthKey);
    DateTime periodStart = new(year, month, 1, 0, 0, 0, DateTimeKind.Utc);
    DateTime periodEnd = periodStart.AddMonths(1).AddTicks(-1);

    IReadOnlyList<TransactionDto> periodTransactions = allTransactions
      .Where(x => x.DateUtc.Year == year && x.DateUtc.Month == month)
      .ToList();

    IReadOnlyList<BudgetDto> budgets = await BudgetsApi.GetMonthAsync(year, month);

    income = periodTransactions
      .Where(x => x.Type == PocketPilotAI.Core.Domain.Enums.TransactionType.Income)
      .Sum(x => x.Amount);

    expenses = periodTransactions
      .Where(x => x.Type == PocketPilotAI.Core.Domain.Enums.TransactionType.Expense)
      .Sum(x => x.Amount);

    remainingBudget = budgets.Sum(x => x.RemainingAmount);

    decimal recurringExpense = periodTransactions
      .Where(x => x.Type == PocketPilotAI.Core.Domain.Enums.TransactionType.Expense && x.IsRecurring)
      .Sum(x => x.Amount);

    recurringShare = expenses <= 0 ? 0 : recurringExpense / expenses;

    healthScore = BuildHealthScore(income, expenses, remainingBudget, recurringShare);
    healthSummary = BuildHealthSummary(healthScore, income, expenses);

    trendItems = BuildTrend(allTransactions, periodStart);
    trendMax = trendItems.Any() ? trendItems.Max(x => x.Amount) : 0;

    leakCards = await InsightsApi.GetLeakInsightsAsync(new LeakFinderRequest
    {
      FromUtc = periodStart,
      ToUtc = periodEnd,
      MaxSuggestions = 4
    });

    estimatedImpact = leakCards.Sum(x => x.EstimatedMonthlySavings);

    actionChips = leakCards
      .Take(3)
      .Select(x => x.SuggestedAction)
      .ToList();

    isLoadingNarrative = true;

    IReadOnlyList<InsightCardDto> monthlySummary = await InsightsApi.GetMonthlySummaryAsync(new MonthlySummaryRequest
    {
      Year = year,
      Month = month
    });

    if (monthlySummary.Count > 0)
    {
      monthlyNarrative = RewriteNarrative(monthlySummary[0].Description);
      primaryRecommendation = RewriteRecommendation(monthlySummary[0].SuggestedAction);
    }
    else
    {
      monthlyNarrative = "You are ready to improve one category this month. Run a quick what-if to estimate the impact before acting.";
      primaryRecommendation = "Reduce one high-growth category by 10-15% for the next 30 days.";
    }

    isLoadingNarrative = false;
  }

  private static int BuildHealthScore(decimal income, decimal expenses, decimal remainingBudget, decimal recurringShare)
  {
    decimal savingsRate = income <= 0 ? 0 : (income - expenses) / income;

    decimal score = 56m;
    score += savingsRate * 30m;
    score += remainingBudget > 0 ? 10m : -10m;
    score += recurringShare < 0.35m ? 8m : -8m;

    return (int)Math.Clamp(Math.Round(score), 0, 100);
  }

  private static string BuildHealthSummary(int score, decimal income, decimal expenses)
  {
    if (income <= 0)
    {
      return "No income registered for this month yet. Add income to unlock an accurate health score.";
    }

    decimal net = income - expenses;
    if (net >= 0)
    {
      return $"You are currently positive by {net:0} SEK this month.";
    }

    return $"You are currently overspending by {Math.Abs(net):0} SEK this month.";
  }

  private static IReadOnlyList<TrendItem> BuildTrend(IReadOnlyList<TransactionDto> transactions, DateTime anchorMonth)
  {
    List<TrendItem> result = [];

    for (int i = 5; i >= 0; i--)
    {
      DateTime month = new DateTime(anchorMonth.Year, anchorMonth.Month, 1, 0, 0, 0, DateTimeKind.Utc).AddMonths(-i);
      decimal spend = transactions
        .Where(x => x.Type == PocketPilotAI.Core.Domain.Enums.TransactionType.Expense)
        .Where(x => x.DateUtc.Year == month.Year && x.DateUtc.Month == month.Month)
        .Sum(x => x.Amount);

      result.Add(new TrendItem(month.ToString("MMM"), spend));
    }

    return result;
  }

  private static IReadOnlyList<MonthOption> BuildMonthOptions(IReadOnlyList<TransactionDto> transactions)
  {
    HashSet<string> keys = new(StringComparer.Ordinal);

    foreach (var tx in transactions)
    {
      keys.Add(BuildKey(tx.DateUtc.Year, tx.DateUtc.Month));
    }

    keys.Add(BuildKey(DateTime.UtcNow.Year, DateTime.UtcNow.Month));

    return keys
      .Select(ParseKey)
      .OrderByDescending(x => x.year)
      .ThenByDescending(x => x.month)
      .Take(8)
      .Select(x => new MonthOption(BuildKey(x.year, x.month), new DateTime(x.year, x.month, 1).ToString("MMMM yyyy")))
      .ToList();
  }

  private static string RewriteNarrative(string narrative)
    => string.IsNullOrWhiteSpace(narrative)
      ? "No AI narrative available yet."
      : narrative
        .Replace("KPI", "key metric")
        .Replace("baseline", "last month")
        .Replace("simulated", "improved");

  private static string RewriteRecommendation(string recommendation)
    => string.IsNullOrWhiteSpace(recommendation)
      ? "Run one scenario and apply the highest-impact action this week."
      : recommendation;

  private static string BuildKey(int year, int month)
    => $"{year:D4}-{month:D2}";

  private static (int year, int month) ParseKey(string key)
  {
    string[] parts = key.Split('-', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
    if (parts.Length != 2 || !int.TryParse(parts[0], out int year) || !int.TryParse(parts[1], out int month))
    {
      return (DateTime.UtcNow.Year, DateTime.UtcNow.Month);
    }

    return (year, month);
  }

  private sealed record TrendItem(string Label, decimal Amount);

  private sealed record MonthOption(string Key, string Label);
}
