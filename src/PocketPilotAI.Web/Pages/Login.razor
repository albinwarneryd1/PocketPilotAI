@page "/login"
@inject AuthApi AuthApi
@inject UserSessionState Session
@inject NavigationManager NavigationManager

<div class="auth-page">
  <HeroCard AdditionalClass="auth-card card-rise">
    <div class="auth-brand">
      <span class="auth-brand-mark">PP</span>
      <div>
        <p class="page-kicker">PocketPilotAI</p>
        <h2 class="page-title">Welcome back</h2>
      </div>
    </div>

    <p class="muted">Sign in to continue to your AI-powered finance workspace.</p>

    <div class="form-grid single">
      <PremiumFormField Label="Email">
        <InputText @bind-Value="email" placeholder="demo@pocketpilot.ai" />
      </PremiumFormField>

      <PremiumFormField Label="Password">
        <InputText @bind-Value="password" type="password" placeholder="Your password" />
      </PremiumFormField>
    </div>

    <div class="auth-actions">
      <button class="btn-primary" @onclick="SubmitLogin" disabled="@isBusy">@(isBusy ? "Signing in..." : "Sign in")</button>
      <button class="btn-secondary" @onclick="UseDemo" disabled="@isBusy">Demo login</button>
      <a class="btn-tertiary" href="/register">Create account</a>
    </div>

    @if (!string.IsNullOrWhiteSpace(error))
    {
      <p class="error-text">@error</p>
    }
  </HeroCard>
</div>

@code {
  [SupplyParameterFromQuery] public string? ReturnUrl { get; set; }

  private string email = string.Empty;
  private string password = string.Empty;
  private string? error;
  private bool isBusy;

  protected override void OnInitialized()
  {
    if (Session.IsAuthenticated)
    {
      NavigationManager.NavigateTo("/overview");
    }
  }

  private async Task SubmitLogin()
  {
    isBusy = true;
    error = null;

    try
    {
      var token = await AuthApi.LoginAsync(new PocketPilotAI.Core.Application.Dtos.Users.LoginRequest
      {
        Email = email,
        Password = password
      });

      if (token is null)
      {
        error = "Invalid credentials or API unavailable.";
        return;
      }

      Session.SetSession(token);
      string target = string.IsNullOrWhiteSpace(ReturnUrl)
        ? "/overview"
        : (ReturnUrl.StartsWith("/") ? ReturnUrl : $"/{ReturnUrl}");

      NavigationManager.NavigateTo(target);
    }
    catch (Exception)
    {
      error = "Sign-in failed. Verify API availability and try again.";
    }
    finally
    {
      isBusy = false;
    }
  }

  private async Task UseDemo()
  {
    email = "demo@pocketpilot.ai";
    password = "Demo1234!";
    await SubmitLogin();
  }
}
