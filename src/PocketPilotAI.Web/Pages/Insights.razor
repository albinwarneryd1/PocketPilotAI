@page "/insights"
@inject InsightsApi InsightsApi
@implements IDisposable

<div class="page-stack decision-flow">
  <section class="page-head">
    <div class="page-head-copy">
      <p class="page-kicker">AI coach</p>
      <h2 class="page-title">Decision assistant</h2>
      <p class="muted">Understand the impact first, then act.</p>
    </div>
  </section>

  <HeroCard AdditionalClass="decision-hero card-rise">
    <p class="decision-kicker">Hero outcome</p>
    <h3 class="decision-value">@heroOutcomeValue</h3>
    <p class="decision-subtitle">@heroOutcomeSubtitle</p>

    <div class="action-row">
      <a class="btn-primary" href="/transactions">Apply scenario</a>
      <a class="btn-secondary" href="#scenario-details">Adjust scenario</a>
    </div>

    @if (outcomeChips.Any())
    {
      <div class="outcome-chip-row">
        @foreach (var chip in outcomeChips)
        {
          <span class="outcome-chip">@chip</span>
        }
      </div>
    }
  </HeroCard>

  <AIExplanationBlock
    Title="Why this matters"
    Body="@humanExplanation"
    IsLoading="@isLoadingNarrative" />

  <RecommendationCard
    Title="Next best move"
    Description="@topRecommendation"
    ImpactText="@impactText"
    CtaLabel="Apply this plan"
    CtaHref="/transactions" />

  <section class="panel">
    <div class="section-header-copy">
      <h3 class="section-title">Before vs after</h3>
      <p class="muted">One chart focused on outcome, not noise.</p>
    </div>

    @if (simulation is null)
    {
      <div class="skeleton-stack" aria-hidden="true">
        <span class="skeleton-line full"></span>
        <span class="skeleton-line medium"></span>
      </div>
    }
    else
    {
      <div class="before-after-chart card-rise">
        @foreach (var row in outcomeRows)
        {
          decimal max = Math.Max(Math.Abs(row.Before), Math.Abs(row.After));
          <div class="before-after-item">
            <div class="before-after-head">
              <span class="before-after-label">@row.Label</span>
              <strong>@FormatMetric(row.After, row.IsPercent)</strong>
            </div>
            <div class="compare-bar baseline">
              <div style="width:@BarWidth(row.Before, max)"></div>
            </div>
            <div class="compare-bar simulated">
              <div style="width:@BarWidth(row.After, max)"></div>
            </div>
            <small class="muted">Before @FormatMetric(row.Before, row.IsPercent) -> After @FormatMetric(row.After, row.IsPercent)</small>
          </div>
        }
      </div>
    }
  </section>

  <details class="decision-details" id="scenario-details">
    <summary>Scenario setup and detailed metrics</summary>
    <div class="decision-details-body">
      <section class="panel">
        <div class="section-header-copy">
          <h3 class="section-title">Scenario controls</h3>
          <p class="muted">Change one variable, rerun, compare.</p>
        </div>

        @if (templates.Any())
        {
          <div class="preset-row">
            @foreach (var template in templates)
            {
              <button type="button" class="preset-chip @(template.Name == selectedTemplateName ? "selected" : string.Empty)" @onclick="() => OnTemplateSelected(template)">
                <span>@template.Name</span>
                <small>@template.SuggestedCategory â€¢ @template.SuggestedValue.ToString("0.#")</small>
              </button>
            }
          </div>
        }

        <div class="form-grid">
          <PremiumFormField Label="Scenario name">
            <InputText @bind-Value="ScenarioNameInput" />
          </PremiumFormField>

          <PremiumFormField Label="Year">
            <InputNumber @bind-Value="YearInput" />
          </PremiumFormField>

          <PremiumFormField Label="Month">
            <InputNumber @bind-Value="MonthInput" />
          </PremiumFormField>

          <PremiumFormField Label="Action type">
            <InputSelect @bind-Value="SelectedTypeInput">
              @foreach (var type in actionTypes)
              {
                <option value="@type">@ToDisplay(type)</option>
              }
            </InputSelect>
          </PremiumFormField>

          <PremiumFormField Label="Category">
            <InputText @bind-Value="CategoryInput" />
          </PremiumFormField>

          <PremiumFormField Label="Value">
            <InputNumber @bind-Value="ActionValueInput" />
          </PremiumFormField>
        </div>

        <div class="action-row">
          <button class="btn-primary" @onclick="RunSimulation" disabled="@isSimulating">@(isSimulating ? "Updating..." : "Run simulation")</button>
          <TrendBadge Label="@lastUpdatedLabel" Variant="neutral" />
        </div>
      </section>

      @if (simulation is not null)
      {
        <section class="panel">
          <div class="section-header-copy">
            <h3 class="section-title">Detailed numbers</h3>
            <p class="muted">Expanded metrics for deeper review.</p>
          </div>

          <div class="kpi-grid">
            <BaseCard>
              <p class="metric-eyebrow">Before</p>
              <p>Income <strong>@simulation.Baseline.Income.ToString("0") SEK</strong></p>
              <p>Expenses <strong>@simulation.Baseline.Expenses.ToString("0") SEK</strong></p>
              <p>Net <strong>@simulation.Baseline.Net.ToString("0") SEK</strong></p>
            </BaseCard>
            <BaseCard>
              <p class="metric-eyebrow">After</p>
              <p>Income <strong>@simulation.Simulated.Income.ToString("0") SEK</strong></p>
              <p>Expenses <strong>@simulation.Simulated.Expenses.ToString("0") SEK</strong></p>
              <p>Net <strong>@simulation.Simulated.Net.ToString("0") SEK</strong></p>
            </BaseCard>
            <BaseCard>
              <p class="metric-eyebrow">Delta</p>
              <p>Income <strong>@simulation.Delta.IncomeDelta.ToString("0") SEK</strong></p>
              <p>Expenses <strong>@simulation.Delta.ExpenseDelta.ToString("0") SEK</strong></p>
              <p>Net <strong>@simulation.Delta.NetDelta.ToString("0") SEK</strong></p>
            </BaseCard>
          </div>
        </section>
      }

      @if (supportingInsights.Any())
      {
        <section class="panel">
          <div class="section-header-copy">
            <h3 class="section-title">Supporting insights</h3>
            <p class="muted">Useful context if you want to go deeper.</p>
          </div>

          <div class="insight-grid">
            @foreach (var card in supportingInsights)
            {
              <InsightCard Item="card" ActionLabel="Review" ActionHref="/transactions" />
            }
          </div>
        </section>
      }
    </div>
  </details>
</div>

@code {
  private readonly WhatIfActionType[] actionTypes = Enum.GetValues<WhatIfActionType>();

  private IReadOnlyList<InsightCardDto> allInsights = [];
  private IReadOnlyList<InsightCardDto> supportingInsights = [];
  private IReadOnlyList<WhatIfScenarioTemplateDto> templates = [];

  private WhatIfSimulationResultDto? simulation;
  private InsightCardDto? primaryInsight;

  private string scenarioName = "30-day plan";
  private int year = DateTime.UtcNow.Year;
  private int month = DateTime.UtcNow.Month;
  private WhatIfActionType selectedType = WhatIfActionType.ReduceCategoryPercent;
  private string categoryName = "Eating Out";
  private decimal actionValue = 15;
  private string selectedTemplateName = string.Empty;

  private bool isSimulating;
  private bool isLoadingNarrative = true;
  private string lastUpdatedLabel = "Not simulated";

  private string heroOutcomeValue = "Calculating...";
  private string heroOutcomeSubtitle = "Run your scenario to see your potential impact.";
  private string humanExplanation = "Generating your monthly insights...";
  private string topRecommendation = "Run one simulation and apply the best outcome.";
  private string impactText = "No impact estimate yet.";

  private IReadOnlyList<string> outcomeChips = [];
  private IReadOnlyList<OutcomeRow> outcomeRows = [];

  private CancellationTokenSource? debounceCts;

  private string ScenarioNameInput
  {
    get => scenarioName;
    set
    {
      if (scenarioName == value)
      {
        return;
      }

      scenarioName = value;
      _ = QueueSimulationAsync();
    }
  }

  private int YearInput
  {
    get => year;
    set
    {
      if (year == value)
      {
        return;
      }

      year = value;
      _ = QueueSimulationAsync();
    }
  }

  private int MonthInput
  {
    get => month;
    set
    {
      if (month == value)
      {
        return;
      }

      month = value;
      _ = QueueSimulationAsync();
    }
  }

  private WhatIfActionType SelectedTypeInput
  {
    get => selectedType;
    set
    {
      if (selectedType == value)
      {
        return;
      }

      selectedType = value;
      _ = QueueSimulationAsync();
    }
  }

  private string CategoryInput
  {
    get => categoryName;
    set
    {
      if (categoryName == value)
      {
        return;
      }

      categoryName = value;
      _ = QueueSimulationAsync();
    }
  }

  private decimal ActionValueInput
  {
    get => actionValue;
    set
    {
      if (actionValue == value)
      {
        return;
      }

      actionValue = value;
      _ = QueueSimulationAsync();
    }
  }

  protected override async Task OnInitializedAsync()
  {
    templates = await InsightsApi.GetWhatIfTemplatesAsync();
    if (templates.Any())
    {
      ApplyTemplate(templates[0]);
    }

    allInsights = await InsightsApi.GetLeakInsightsAsync(new LeakFinderRequest
    {
      FromUtc = DateTime.UtcNow.AddMonths(-1),
      ToUtc = DateTime.UtcNow,
      MaxSuggestions = 5
    });

    primaryInsight = allInsights.FirstOrDefault();
    supportingInsights = allInsights.Skip(1).Take(3).ToList();

    await BuildNarrativeAsync();
    await RunSimulation();
  }

  private async Task BuildNarrativeAsync()
  {
    isLoadingNarrative = true;

    IReadOnlyList<InsightCardDto> monthlySummary = await InsightsApi.GetMonthlySummaryAsync(new MonthlySummaryRequest
    {
      Year = DateTime.UtcNow.Year,
      Month = DateTime.UtcNow.Month
    });

    string narrative = monthlySummary.FirstOrDefault()?.Description
      ?? primaryInsight?.Description
      ?? "No narrative available yet.";

    humanExplanation = RewriteToHumanTone(narrative);
    topRecommendation = primaryInsight?.SuggestedAction
      ?? monthlySummary.FirstOrDefault()?.SuggestedAction
      ?? "Apply one realistic cut in your highest growth category.";

    isLoadingNarrative = false;
  }

  private async Task RunSimulation()
  {
    isSimulating = true;

    try
    {
      simulation = await InsightsApi.SimulateAsync(new WhatIfSimulationRequest
      {
        ScenarioName = scenarioName,
        Year = year,
        Month = month,
        Actions =
        [
          new WhatIfActionDto
          {
            Type = selectedType,
            Label = selectedType.ToString(),
            CategoryName = categoryName,
            Value = actionValue,
            TransactionType = selectedType == WhatIfActionType.AddRecurringIncome
              ? PocketPilotAI.Core.Domain.Enums.TransactionType.Income
              : PocketPilotAI.Core.Domain.Enums.TransactionType.Expense,
            IsRecurring = selectedType != WhatIfActionType.AddOneOffTransaction,
            EffectiveDateUtc = DateTime.UtcNow
          }
        ]
      });

      if (simulation is null)
      {
        heroOutcomeValue = "No simulation result";
        heroOutcomeSubtitle = "Try adjusting the scenario and run again.";
        impactText = "No impact estimate available.";
        outcomeRows = [];
        outcomeChips = [];
        lastUpdatedLabel = "Simulation failed";
        return;
      }

      BuildHeroStory(simulation);
      BuildOutcomeRows(simulation);
      lastUpdatedLabel = $"Updated {DateTime.Now:HH:mm:ss}";
    }
    finally
    {
      isSimulating = false;
    }
  }

  private void BuildHeroStory(WhatIfSimulationResultDto result)
  {
    decimal delta = result.Delta.NetDelta;

    heroOutcomeValue = delta >= 0
      ? $"+{delta:0} SEK / month potential"
      : $"{delta:0} SEK / month impact";

    heroOutcomeSubtitle = delta >= 0
      ? $"You could save about {delta:0} SEK each month if you apply this scenario."
      : $"This scenario may reduce your net by {Math.Abs(delta):0} SEK each month.";

    impactText = delta >= 0
      ? $"Expected gain: {delta:0} SEK/month"
      : $"Expected loss: {Math.Abs(delta):0} SEK/month";

    outcomeChips =
    [
      $"Savings rate change {result.Delta.SavingsRateDeltaPercent:0.0}%",
      $"Category focus: {categoryName}",
      $"Action: {ToDisplay(selectedType)}"
    ];

    string simulatedNarrative = delta >= 0
      ? $"You improve your net by {delta:0} SEK."
      : $"You reduce your net by {Math.Abs(delta):0} SEK.";

    humanExplanation = $"{simulatedNarrative} {RewriteToHumanTone(topRecommendation)}";
  }

  private void BuildOutcomeRows(WhatIfSimulationResultDto result)
  {
    outcomeRows =
    [
      new("Net cash flow", result.Baseline.Net, result.Simulated.Net),
      new("Savings rate", result.Baseline.SavingsRatePercent, result.Simulated.SavingsRatePercent, true)
    ];
  }

  private void OnTemplateSelected(WhatIfScenarioTemplateDto template)
  {
    ApplyTemplate(template);
    _ = QueueSimulationAsync();
  }

  private async Task QueueSimulationAsync()
  {
    debounceCts?.Cancel();
    debounceCts?.Dispose();
    debounceCts = new CancellationTokenSource();

    try
    {
      await Task.Delay(320, debounceCts.Token);
      await RunSimulation();
      await InvokeAsync(StateHasChanged);
    }
    catch (TaskCanceledException)
    {
      // ignore fast input churn
    }
  }

  private void ApplyTemplate(WhatIfScenarioTemplateDto template)
  {
    selectedTemplateName = template.Name;
    selectedType = template.ActionType;
    categoryName = template.SuggestedCategory;
    actionValue = template.SuggestedValue;
    scenarioName = $"{template.Name} scenario";
  }

  private static string RewriteToHumanTone(string input)
  {
    if (string.IsNullOrWhiteSpace(input))
    {
      return "You can improve your month by making one small adjustment in your highest-growth category.";
    }

    return input
      .Replace("Scenario shifts", "You can change")
      .Replace("net cash flow", "your monthly net")
      .Replace("If current behavior continues", "If you keep this pace")
      .Trim();
  }

  private static string ToDisplay(WhatIfActionType type)
    => type switch
    {
      WhatIfActionType.ReduceCategoryPercent => "Reduce category by %",
      WhatIfActionType.ReduceCategoryFixed => "Reduce category by fixed amount",
      WhatIfActionType.AddRecurringIncome => "Add recurring income",
      WhatIfActionType.AddRecurringExpense => "Add recurring expense",
      WhatIfActionType.AddOneOffTransaction => "Add one-off transaction",
      WhatIfActionType.RemoveDetectedSubscriptions => "Remove subscriptions",
      _ => type.ToString()
    };

  private static string BarWidth(decimal value, decimal max)
  {
    decimal width = max <= 0 ? 0 : (Math.Abs(value) / max) * 100m;
    return $"{width:0}%";
  }

  private static string FormatMetric(decimal value, bool isPercent)
    => isPercent ? $"{value:0.0}%" : $"{value:0} SEK";

  public void Dispose()
  {
    debounceCts?.Cancel();
    debounceCts?.Dispose();
  }

  private sealed record OutcomeRow(string Label, decimal Before, decimal After, bool IsPercent = false);
}
